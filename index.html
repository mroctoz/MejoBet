<!DOCTYPE html>
<html lang="pt-br" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MejoBet - Apostas</title>
    
    <!-- Framework Visual (Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bet: {
                            header: '#126e51', // Verde Institucional
                            bg: '#202020',     // Fundo Dark
                            card: '#2b2b2b',   // Fundo Cartão
                            card_hover: '#333333',
                            accent: '#ffdf1b', // Amarelo Odd
                            live: '#00ffb4',   // Verde Ao Vivo
                            text: '#e0e0e0',
                            text_muted: '#999999'
                        }
                    },
                    fontFamily: { sans: ['Roboto', 'sans-serif'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { background-color: #202020; color: #e0e0e0; -webkit-tap-highlight-color: transparent; }
        
        /* Layout Grid da Partida (Igual Bet365) */
        .match-grid {
            display: grid;
            grid-template-columns: 50px 1fr 130px; /* Tempo | Times | Odds */
            align-items: center;
            border-top: 1px solid #383838;
            padding: 12px 10px;
            background: #2b2b2b;
            transition: background 0.2s;
        }
        .match-grid:hover { background: #333; }

        /* Coluna dos Times */
        .teams-wrapper { display: flex; flex-direction: column; gap: 6px; padding-right: 10px; }
        .team-row { display: flex; align-items: center; gap: 8px; height: 20px; }
        
        /* Logos Fixos */
        .team-logo { 
            width: 18px; height: 18px; min-width: 18px; 
            object-fit: contain; 
        }
        .logo-fallback {
            width: 18px; height: 18px; min-width: 18px;
            border-radius: 50%; font-size: 8px; font-weight: bold;
            display: flex; align-items: center; justify-content: center; color: #000;
        }

        /* Botões de Aposta */
        .odds-wrapper { display: flex; gap: 2px; }
        .odd-btn {
            background: #3e3e3e;
            color: #ffdf1b;
            flex: 1;
            height: 40px;
            border-radius: 2px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.1s;
        }
        .odd-btn:hover { background: #555; color: #fff; }
        .odd-btn:active { transform: scale(0.98); }
        .odd-header { font-size: 9px; color: #aaa; font-weight: normal; margin-bottom: -2px; }

        /* Status Ao Vivo */
        .live-dot {
            width: 6px; height: 6px; background-color: #00ffb4;
            border-radius: 50%; display: inline-block;
            box-shadow: 0 0 5px #00ffb4;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% {opacity: 1;} 50% {opacity: 0.5;} 100% {opacity: 1;} }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- Header -->
    <header class="bg-bet-header h-14 flex items-center justify-between px-4 shrink-0 shadow-lg z-20">
        <div class="flex items-center gap-1">
            <i class="fas fa-bars text-white/70 mr-3 text-lg"></i>
            <span class="font-bold text-xl italic tracking-tighter text-white">Mejo<span class="text-bet-accent">Bet</span></span>
        </div>
        
        <div class="flex items-center gap-3">
            <div class="text-right">
                <div class="text-[10px] text-gray-300 font-bold uppercase">Saldo</div>
                <div class="text-bet-accent font-bold text-sm" id="user-balance">R$ 0.00</div>
            </div>
            <div class="w-8 h-8 rounded-full bg-black/20 flex items-center justify-center text-white">
                <i class="fas fa-user"></i>
            </div>
        </div>
    </header>

    <!-- Navegação Ligas (Scroll Horizontal) -->
    <div class="bg-[#2b2b2b] border-b border-[#383838] h-11 flex items-center px-2 gap-1 overflow-x-auto whitespace-nowrap shrink-0 text-xs text-gray-400 font-bold no-scrollbar">
        <button onclick="filtrar('TODOS')" class="nav-item active px-3 h-full border-b-2 border-white text-white">Todos</button>
        <button onclick="filtrar('IN_PLAY')" class="nav-item px-3 h-full border-b-2 border-transparent hover:text-white flex items-center gap-1">
            <span class="live-dot"></span> Ao Vivo
        </button>
        <button onclick="filtrar('BSA')" class="nav-item px-3 h-full border-b-2 border-transparent hover:text-white">Brasileirão</button>
        <button onclick="filtrar('PL')" class="nav-item px-3 h-full border-b-2 border-transparent hover:text-white">Inglaterra</button>
        <button onclick="filtrar('CL')" class="nav-item px-3 h-full border-b-2 border-transparent hover:text-white">Champions</button>
        
        <div class="flex-1"></div>
        <button onclick="toggleHistory()" class="text-bet-accent px-3">Minhas Apostas</button>
    </div>

    <!-- Conteúdo Principal -->
    <main class="flex-1 overflow-y-auto relative bg-bet-bg" id="main-content">
        <!-- Loading -->
        <div id="loading" class="text-center mt-10 text-gray-500 text-xs">
            <i class="fas fa-circle-notch fa-spin text-bet-header text-2xl mb-2"></i><br>Atualizando Odds...
        </div>

        <!-- Feed de Jogos -->
        <div id="feed-container" class="pb-24"></div>
    </main>

    <!-- BOLETIM DE APOSTA (Mobile Sticky Footer) -->
    <div id="bet-slip-panel" class="fixed bottom-0 left-0 right-0 bg-[#2b2b2b] border-t border-bet-header z-50 transform translate-y-full transition-transform duration-300 shadow-2xl">
        <!-- Header do Boletim -->
        <div class="h-10 bg-bet-header flex justify-between items-center px-4 cursor-pointer" onclick="toggleSlip()">
            <div class="flex items-center gap-2">
                <span class="bg-bet-accent text-black text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center" id="slip-count">0</span>
                <span class="text-white font-bold text-sm">Boletim de Aposta</span>
            </div>
            <i class="fas fa-chevron-up text-white text-xs" id="slip-icon"></i>
        </div>

        <!-- Conteúdo do Boletim -->
        <div class="p-4 bg-[#2b2b2b]">
            <div id="slip-content">
                <!-- Inserido via JS -->
            </div>
            
            <div class="mt-4 pt-4 border-t border-[#444]">
                <div class="flex justify-between text-xs text-gray-400 mb-2">
                    <span>Retorno Potencial:</span>
                    <span class="text-bet-accent font-bold text-sm" id="slip-return">R$ 0.00</span>
                </div>
                
                <div class="flex gap-2">
                    <input type="number" id="bet-amount" class="bg-[#1a1a1a] border border-[#444] text-white text-sm rounded p-3 w-1/3 outline-none focus:border-bet-header" placeholder="Valor">
                    <button onclick="placeBet()" class="bg-bet-accent text-black font-bold text-sm rounded w-2/3 hover:bg-white transition">CONFIRMAR APOSTA</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Histórico -->
    <div id="history-modal" class="hidden fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-[#2b2b2b] w-full max-w-md rounded shadow-lg border border-[#444] max-h-[80vh] flex flex-col">
            <div class="p-3 border-b border-[#444] flex justify-between items-center bg-bet-header">
                <h3 class="font-bold text-white text-sm">Histórico</h3>
                <button onclick="toggleHistory()" class="text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="history-list" class="p-3 overflow-y-auto space-y-2 bg-[#202020]"></div>
        </div>
    </div>

    <!-- Lógica JavaScript Completa -->
    <script>
        // --- ESTADO ---
        const STATE = {
            balance: 250.00,
            games: [], // Todos os jogos carregados
            cart: [],  // Aposta atual
            bets: [],  // Histórico
            filter: 'TODOS'
        };

        const API_URL = 'dados_futebol.json';

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            loadUserData();
            fetchData();
            
            // Polling para "Tempo Real" (Atualiza a cada 30s)
            setInterval(fetchData, 30000);
            
            // Listener de input
            document.getElementById('bet-amount').addEventListener('input', calcReturn);
        });

        // --- FETCH DADOS ---
        async function fetchData() {
            try {
                // Adiciona timestamp para evitar cache do navegador
                const res = await fetch(API_URL + '?t=' + Date.now());
                if (!res.ok) throw new Error("Aguardando geração do arquivo...");
                
                const data = await res.json();
                
                // Salva jogos no estado global
                STATE.games = data.jogos || [];
                
                // Verifica se ganhou alguma aposta antiga
                checkResults();
                
                renderFeed();
                document.getElementById('loading').style.display = 'none';
                
            } catch (e) {
                console.log("Sincronizando...", e);
            }
        }

        // --- RENDERIZAÇÃO ---
        function renderFeed() {
            const container = document.getElementById('feed-container');
            container.innerHTML = '';

            // 1. Filtragem
            const filtered = STATE.games.filter(g => {
                if (STATE.filter === 'TODOS') return true;
                if (STATE.filter === 'IN_PLAY') return g.status === 'IN_PLAY' || g.status === 'PAUSED';
                return g.liga_code === STATE.filter;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-10 text-xs">Nenhum jogo disponível no momento.</div>';
                return;
            }

            // 2. Agrupamento por Liga (Estilo Bet365)
            const grouped = {};
            filtered.forEach(g => {
                if (!grouped[g.liga]) grouped[g.liga] = [];
                grouped[g.liga].push(g);
            });

            // 3. Gerar HTML
            for (const [liga, jogos] of Object.entries(grouped)) {
                // Cabeçalho da Liga
                const header = document.createElement('div');
                header.className = 'bg-[#333] px-3 py-1.5 text-[10px] font-bold text-[#ccc] uppercase tracking-wide border-t border-[#444] sticky top-0 z-10';
                header.innerText = liga;
                container.appendChild(header);

                jogos.forEach(game => {
                    const isLive = game.status === 'IN_PLAY' || game.status === 'PAUSED';
                    const timeText = isLive ? (game.status === 'PAUSED' ? 'INT' : 'AO VIVO') : formatTime(game.data);
                    const timeClass = isLive ? 'text-bet-live font-bold animate-pulse' : 'text-bet-text_muted';
                    
                    // Scores (mostra só se for ao vivo)
                    const scoreHome = isLive ? game.placar_casa : '';
                    const scoreAway = isLive ? game.placar_fora : '';

                    // Criação do Elemento
                    const div = document.createElement('div');
                    div.className = 'match-grid';
                    div.innerHTML = `
                        <!-- Tempo -->
                        <div class="flex flex-col items-center justify-center text-[10px]">
                            <span class="${timeClass}">${timeText}</span>
                            <span class="text-[#666] mt-1 text-[9px]">ID:${game.id.toString().slice(-4)}</span>
                        </div>

                        <!-- Times -->
                        <div class="teams-wrapper">
                            <div class="team-row">
                                ${renderLogo(game.brasao_casa, game.time_casa)}
                                <span class="text-sm text-white font-medium truncate flex-1">${game.time_casa}</span>
                                <span class="text-bet-accent font-bold text-sm">${scoreHome}</span>
                            </div>
                            <div class="team-row">
                                ${renderLogo(game.brasao_fora, game.time_fora)}
                                <span class="text-sm text-white font-medium truncate flex-1">${game.time_fora}</span>
                                <span class="text-bet-accent font-bold text-sm">${scoreAway}</span>
                            </div>
                        </div>

                        <!-- Odds -->
                        <div class="odds-wrapper">
                            <div class="odd-btn" onclick="addToSlip(${game.id}, 'home', ${game.odds.home})">
                                <span class="odd-header">1</span>${game.odds.home.toFixed(2)}
                            </div>
                            <div class="odd-btn" onclick="addToSlip(${game.id}, 'draw', ${game.odds.draw})">
                                <span class="odd-header">X</span>${game.odds.draw.toFixed(2)}
                            </div>
                            <div class="odd-btn" onclick="addToSlip(${game.id}, 'away', ${game.odds.away})">
                                <span class="odd-header">2</span>${game.odds.away.toFixed(2)}
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }
        }

        // --- SISTEMA DE APOSTAS ---
        function addToSlip(gameId, pick, odd) {
            // Busca o jogo completo no State para garantir dados corretos
            const game = STATE.games.find(g => g.id === gameId);
            if (!game) return;

            let pickName = pick === 'draw' ? 'Empate' : (pick === 'home' ? game.time_casa : game.time_fora);

            STATE.cart = [{
                gameId: game.id,
                matchName: `${game.time_casa} x ${game.time_fora}`,
                pick: pick, // 'home', 'draw', 'away'
                pickName: pickName,
                odd: odd
            }];

            renderSlip();
            openSlip();
        }

        function renderSlip() {
            const container = document.getElementById('slip-content');
            if (STATE.cart.length === 0) {
                container.innerHTML = '';
                return;
            }
            const item = STATE.cart[0];
            container.innerHTML = `
                <div class="bg-[#222] p-3 rounded border-l-4 border-bet-header relative">
                    <button onclick="clearSlip()" class="absolute top-2 right-2 text-gray-500"><i class="fas fa-times"></i></button>
                    <div class="text-[10px] text-bet-header font-bold uppercase mb-1">Resultado Final</div>
                    <div class="text-sm text-white font-bold mb-1">${item.pickName}</div>
                    <div class="text-xs text-gray-400">${item.matchName}</div>
                    <div class="absolute bottom-3 right-3 bg-bet-header text-white px-2 py-0.5 rounded text-xs font-bold">
                        ${item.odd.toFixed(2)}
                    </div>
                </div>
            `;
            document.getElementById('slip-count').innerText = '1';
        }

        function placeBet() {
            const input = document.getElementById('bet-amount');
            const val = parseFloat(input.value);

            if (!val || val <= 0) return alert("Valor inválido");
            if (val > STATE.balance) return alert("Saldo insuficiente");

            STATE.balance -= val;
            
            const bet = {
                ...STATE.cart[0],
                stake: val,
                potential: val * STATE.cart[0].odd,
                status: 'OPEN',
                date: new Date().toISOString()
            };

            STATE.bets.unshift(bet);
            saveUserData();
            clearSlip();
            alert("Aposta confirmada!");
            closeSlip();
        }

        // --- CHECAGEM DE RESULTADOS ---
        function checkResults() {
            let changed = false;
            STATE.bets.forEach(bet => {
                if (bet.status === 'OPEN') {
                    // Procura o jogo no JSON atualizado
                    const game = STATE.games.find(g => g.id === bet.gameId);
                    
                    // Só verifica se o jogo acabou (FINISHED)
                    if (game && game.status === 'FINISHED') {
                        let result = 'draw';
                        if (game.placar_casa > game.placar_fora) result = 'home';
                        if (game.placar_fora > game.placar_casa) result = 'away';

                        if (bet.pick === result) {
                            bet.status = 'WON';
                            STATE.balance += bet.potential;
                        } else {
                            bet.status = 'LOST';
                        }
                        changed = true;
                    }
                }
            });

            if (changed) {
                saveUserData();
                alert("Resultados atualizados! Verifique seu saldo.");
            }
        }

        // --- UTILITÁRIOS ---
        function renderLogo(url, name) {
            // Gera um placeholder colorido se a imagem falhar ou não existir
            const color = stringToColor(name);
            const initial = name.substring(0, 2).toUpperCase();
            
            if (url && url.length > 5) {
                return `<img src="${url}" class="team-logo" onerror="this.replaceWith(createFallback('${initial}', '${color}'))">`;
            }
            return `<div class="logo-fallback" style="background:${color}">${initial}</div>`;
        }

        function createFallback(text, color) {
            const div = document.createElement('div');
            div.className = 'logo-fallback';
            div.style.background = color;
            div.innerText = text;
            return div;
        }

        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + '00000'.substring(0, 6 - c.length) + c;
        }

        function formatTime(iso) {
            return new Date(iso).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
        }

        // --- UI MANAGERS ---
        function loadUserData() {
            const b = localStorage.getItem('mb_balance');
            if (b) STATE.balance = parseFloat(b);
            const h = localStorage.getItem('mb_history');
            if (h) STATE.bets = JSON.parse(h);
            updateBalanceUI();
        }
        function saveUserData() {
            localStorage.setItem('mb_balance', STATE.balance.toFixed(2));
            localStorage.setItem('mb_history', JSON.stringify(STATE.bets));
            updateBalanceUI();
        }
        function updateBalanceUI() {
            document.getElementById('user-balance').innerText = `R$ ${STATE.balance.toFixed(2)}`;
        }
        
        function filtrar(code) {
            STATE.filter = code;
            // UI Update
            document.querySelectorAll('.nav-item').forEach(b => {
                b.classList.remove('border-white', 'text-white');
                b.classList.add('border-transparent');
                if (b.getAttribute('onclick').includes(code)) {
                    b.classList.add('border-white', 'text-white');
                    b.classList.remove('border-transparent');
                }
            });
            renderFeed();
        }

        function openSlip() { document.getElementById('bet-slip-panel').style.transform = 'translateY(0%)'; }
        function closeSlip() { document.getElementById('bet-slip-panel').style.transform = 'translateY(100%)'; }
        function toggleSlip() { 
            const el = document.getElementById('bet-slip-panel');
            const isClosed = el.style.transform === 'translateY(100%)' || el.style.transform === '';
            el.style.transform = isClosed ? 'translateY(0%)' : 'translateY(100%)';
        }
        function clearSlip() { STATE.cart = []; renderSlip(); document.getElementById('bet-amount').value = ''; closeSlip(); }
        function calcReturn() {
            const v = parseFloat(document.getElementById('bet-amount').value);
            const o = STATE.cart[0] ? STATE.cart[0].odd : 0;
            const r = v ? (v * o).toFixed(2) : '0.00';
            document.getElementById('slip-return').innerText = `R$ ${r}`;
        }
        function toggleHistory() {
            const el = document.getElementById('history-modal');
            el.classList.toggle('hidden');
            if (!el.classList.contains('hidden')) renderHistory();
        }
        function renderHistory() {
            const l = document.getElementById('history-list');
            l.innerHTML = '';
            STATE.bets.forEach(b => {
                let color = b.status === 'WON' ? 'text-green-400' : (b.status === 'LOST' ? 'text-red-400' : 'text-gray-400');
                l.innerHTML += `
                    <div class="bg-[#2b2b2b] p-2 rounded border border-[#444] text-xs">
                        <div class="flex justify-between font-bold text-white"><span>${b.matchName}</span> <span>R$${b.stake}</span></div>
                        <div class="flex justify-between mt-1"><span class="text-gray-400">${b.pickName} (@${b.odd})</span> <span class="${color} font-bold">${b.status}</span></div>
                    </div>`;
            });
        }
    </script>
</body>
</html>
